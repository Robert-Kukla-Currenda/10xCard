@using TenXCards.API.Models
@using MudBlazor
@inject HttpClient Http
@inject ILogger<FlashcardsList> Logger
@inject ISnackbar Snackbar

<MudGrid>
    @foreach (var card in Cards)
    {        
        <MudItem xs="12">
            <FlashcardItem Card="@card" />
        </MudItem>
    }
</MudGrid>

@if (showConfirmDelete)
{
    <MudDialog Open="showConfirmDelete" 
               DisableSidePadding="true">
        <DialogContent>
            <MudContainer Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Confirm Delete</MudText>
                <MudText>Are you sure you want to delete this card?</MudText>
            </MudContainer>
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Text" 
                      Color="Color.Default" 
                      OnClick="CancelDelete">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Error" 
                      OnClick="ConfirmDelete">Delete</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [Parameter]
    public required List<CardDto> Cards { get; set; }

    [Parameter]
    public EventCallback<CardDto> OnCardDeleted { get; set; }

    private bool showConfirmDelete;
    private CardDto? cardToDelete;
    private CardDto? cardToEdit;
    private bool showEditModal;

    private void HandleEdit(CardDto card)
    {
        cardToEdit = card;
        showEditModal = true;
    }

    private void HandleCardUpdated(CardDto updatedCard)
    {
        var index = Cards.FindIndex(c => c.Id == updatedCard.Id);
        if (index != -1)
        {
            Cards[index] = updatedCard;
            StateHasChanged();
        }
    }

    private void HandleDelete(CardDto card)
    {
        cardToDelete = card;
        showConfirmDelete = true;
    }

    private void CancelDelete()
    {
        showConfirmDelete = false;
        cardToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (cardToDelete == null) return;

        try
        {
            var response = await Http.DeleteAsync($"api/cards/{cardToDelete.Id}");
            
            if (response.IsSuccessStatusCode)
            {
                await OnCardDeleted.InvokeAsync(cardToDelete);
                Cards.Remove(cardToDelete);
                Snackbar.Add("Card deleted successfully", Severity.Success);
            }
            else
            {
                Logger.LogError("Failed to delete card: {StatusCode}", response.StatusCode);
                Snackbar.Add("Failed to delete card", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting card");
            Snackbar.Add("An error occurred while deleting the card", Severity.Error);
        }
        finally
        {
            showConfirmDelete = false;
            cardToDelete = null;
        }
    }
}
